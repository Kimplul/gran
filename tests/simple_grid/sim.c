/* testcase for a 64x64 grid of processors, that all just spam the first memory
 * region due to there being a 'lock' variable there, more or less the worst
 * possible program for performance. */
#include <assert.h>

#include <gran/root.h>
#include <gran/mem/simple_mem.h>
#include <gran/bus/simple_bus.h>
#include <gran/uart/simple_uart.h>
#include <gran/grid/node.h>
#include <gran/grid/router.h>
#include <gran/cpu/riscv/simple_riscv64.h>

unsigned char test_grid[] = {
  0xb3, 0x67, 0xb5, 0x00, 0x63, 0x9a, 0x07, 0x0a, 0xb7, 0x17, 0x00, 0x00,
  0x23, 0xb0, 0x07, 0x00, 0x1b, 0x57, 0x35, 0x00, 0xb7, 0x27, 0x00, 0x00,
  0x93, 0x06, 0x80, 0x02, 0x13, 0x77, 0x77, 0x00, 0x23, 0x80, 0xd7, 0x00,
  0x13, 0x07, 0x07, 0x03, 0x93, 0x76, 0x75, 0x00, 0x23, 0x80, 0xe7, 0x00,
  0x13, 0x87, 0x06, 0x03, 0x23, 0x80, 0xe7, 0x00, 0x93, 0x06, 0xc0, 0x02,
  0x1b, 0xd7, 0x35, 0x00, 0x23, 0x80, 0xd7, 0x00, 0x13, 0x77, 0x77, 0x00,
  0x93, 0x06, 0x00, 0x02, 0x23, 0x80, 0xd7, 0x00, 0x13, 0x07, 0x07, 0x03,
  0x93, 0xf6, 0x75, 0x00, 0x23, 0x80, 0xe7, 0x00, 0x13, 0x87, 0x06, 0x03,
  0x23, 0x80, 0xe7, 0x00, 0x13, 0x07, 0x90, 0x02, 0x23, 0x80, 0xe7, 0x00,
  0x93, 0x06, 0xa0, 0x00, 0x23, 0x80, 0xd7, 0x00, 0x1b, 0x87, 0x15, 0x00,
  0x93, 0x06, 0xf0, 0x03, 0x93, 0x77, 0xf7, 0x0f, 0x63, 0x98, 0xd5, 0x00,
  0x1b, 0x05, 0x15, 0x00, 0x13, 0x75, 0xf5, 0x0f, 0x93, 0x07, 0x00, 0x00,
  0x13, 0x15, 0x85, 0x00, 0x33, 0x65, 0xf5, 0x00, 0xb7, 0x17, 0x00, 0x00,
  0x23, 0xb0, 0xa7, 0x00, 0xb7, 0x16, 0x00, 0x00, 0x37, 0x47, 0x00, 0x00,
  0x83, 0xb7, 0x06, 0x00, 0xe3, 0x9e, 0xe7, 0xfe, 0x73, 0x00, 0x10, 0x00,
  0x67, 0x80, 0x00, 0x00, 0x13, 0x17, 0x85, 0x00, 0x33, 0x67, 0xb7, 0x00,
  0xb7, 0x16, 0x00, 0x00, 0x83, 0xb7, 0x06, 0x00, 0xe3, 0x9e, 0xe7, 0xfe,
  0x6f, 0xf0, 0x5f, 0xf4
};
unsigned int test_grid_len = 208;

static struct component *get_grid(struct component **grid, int i, int j, uint8_t x, uint8_t y)
{
	if (i < 0)
		return NULL;

	if (j < 0)
		return NULL;

	if (i >= x)
		return NULL;

	if (j >= y)
		return NULL;

	return grid[i * x + j];
}

static stat build_grid(struct clock_domain *clk, uint8_t x, uint8_t y)
{
	struct component **grid = calloc(x * y, sizeof(struct component *));
	assert(grid);

	struct component **routers = calloc(x * y, sizeof(struct component *));
	assert(routers);

	for (size_t i = 0; i < x; ++i)
	for (size_t j = 0; j < y; ++j) {
		struct component *imem = create_simple_mem(4096);
		init_simple_mem(imem, 0, test_grid_len, test_grid);

		struct component *dmem = create_simple_mem(4096);
		struct component *router = create_node_router(0, 0, i, j);
		node_router_add(router, dmem, 4096, 4096);

		uint64_t rcv = grid_addr(0, 0, i, j, 16384);
		struct component *rv64 = create_simple_riscv64(rcv, 0, imem, router);
		simple_riscv64_set_reg(rv64, 10, i); /* a0 */
		simple_riscv64_set_reg(rv64, 11, j); /* a1 */

		clock_domain_add(clk, rv64);

		routers[i * x + j] = router;
		grid[i * x + j] = create_grid_node(0, 0, i, j);
	}

	struct component *uart = create_simple_uart();
	node_router_add(routers[0], uart, 8192, 1);

	for (int i = 0; i < x; ++i)
	for (int j = 0; j < y; ++j) {
		struct component *node  = grid[i * x + j];
		struct component *lower = routers[i * x + j];
		struct component *left  = get_grid(grid, i - 1, j    , x, y);
		struct component *right = get_grid(grid, i + 1, j    , x, y);
		struct component *up    = get_grid(grid, i    , j + 1, x, y);
		struct component *down  = get_grid(grid, i    , j - 1, x, y);
		grid_node_connect(node, left, right, up, down, lower, NULL);
		node_router_ascend(lower, node);
	}

	free(routers);
	free(grid);
	return OK;
}

int main()
{
	struct clock_domain *clk = create_clock_domain(NS(1));

	stat r = build_grid(clk, 64, 64);
	assert(r == OK);

	struct gran_root *root = create_root();
	root_add_clock(root, clk);

	r = root_run(root);
	assert(r == OK);

	destroy_root(root);
}
