/* testcase for a 64x64 mesh of processors, that all just spam the first memory
 * region due to there being a 'lock' variable there, more or less the worst
 * possible program for performance. */
#include <assert.h>

#include <gran/root.h>
#include <gran/mem/simple_mem.h>
#include <gran/bus/simple_bus.h>
#include <gran/uart/simple_uart.h>
#include <gran/mesh/node.h>
#include <gran/cpu/riscv/simple_riscv64.h>

unsigned char _tmp_test_bin[] = {
  0x1b, 0x86, 0x05, 0x00, 0x63, 0x18, 0x05, 0x00, 0x93, 0x07, 0x20, 0x00,
  0x1b, 0x86, 0x05, 0x00, 0x63, 0x88, 0xf5, 0x0c, 0x93, 0x16, 0x05, 0x01,
  0x13, 0x07, 0x10, 0x00, 0xb3, 0xe6, 0xb6, 0x00, 0x13, 0x17, 0x07, 0x03,
  0x83, 0x37, 0x07, 0x00, 0xe3, 0x9e, 0xd7, 0xfe, 0x1b, 0x57, 0x35, 0x00,
  0xb7, 0x17, 0x00, 0x00, 0x93, 0x06, 0x80, 0x02, 0x13, 0x77, 0x77, 0x00,
  0x23, 0x80, 0xd7, 0x00, 0x13, 0x07, 0x07, 0x03, 0x93, 0x76, 0x75, 0x00,
  0x23, 0x80, 0xe7, 0x00, 0x13, 0x87, 0x06, 0x03, 0x23, 0x80, 0xe7, 0x00,
  0x93, 0x06, 0xc0, 0x02, 0x1b, 0xd7, 0x35, 0x00, 0x23, 0x80, 0xd7, 0x00,
  0x13, 0x77, 0x77, 0x00, 0x93, 0x06, 0x00, 0x02, 0x23, 0x80, 0xd7, 0x00,
  0x13, 0x07, 0x07, 0x03, 0x93, 0xf6, 0x75, 0x00, 0x23, 0x80, 0xe7, 0x00,
  0x13, 0x87, 0x06, 0x03, 0x23, 0x80, 0xe7, 0x00, 0x13, 0x07, 0x90, 0x02,
  0x23, 0x80, 0xe7, 0x00, 0x13, 0x07, 0xa0, 0x00, 0x23, 0x80, 0xe7, 0x00,
  0x93, 0x07, 0xf0, 0x00, 0x1b, 0x07, 0x05, 0x00, 0x63, 0x06, 0xf5, 0x02,
  0x63, 0x08, 0xf6, 0x02, 0x1b, 0x87, 0x15, 0x00, 0x13, 0x17, 0x07, 0x03,
  0x13, 0x57, 0x07, 0x03, 0x93, 0x17, 0x05, 0x01, 0xb3, 0xe7, 0xe7, 0x00,
  0x13, 0x07, 0x10, 0x00, 0x13, 0x17, 0x07, 0x03, 0x23, 0x30, 0xf7, 0x00,
  0x6f, 0x00, 0x00, 0x00, 0xe3, 0x1e, 0xe6, 0xfc, 0x73, 0x00, 0x10, 0x00,
  0x1b, 0x05, 0x15, 0x00, 0x13, 0x15, 0x05, 0x03, 0x13, 0x55, 0x05, 0x03,
  0x13, 0x07, 0x00, 0x00, 0x6f, 0xf0, 0x1f, 0xfd, 0x93, 0x07, 0x10, 0x00,
  0x93, 0x97, 0x07, 0x03, 0x23, 0xb0, 0x07, 0x00, 0x13, 0x07, 0x00, 0x03,
  0xb7, 0x17, 0x00, 0x00, 0x23, 0x80, 0xe7, 0x00, 0x13, 0x07, 0xa0, 0x00,
  0x23, 0x80, 0xe7, 0x00, 0x6f, 0xf0, 0xdf, 0xf2
};
unsigned int _tmp_test_bin_len = 260;

static struct component *get_mesh(struct component **mesh, int i, int j, uint8_t x, uint8_t y)
{
	if (i < 0)
		return NULL;

	if (j < 0)
		return NULL;

	if (i >= x)
		return NULL;

	if (j >= y)
		return NULL;

	return mesh[i * x + j];
}

static stat build_mesh(struct clock_domain *clk, uint8_t x, uint8_t y)
{
	struct component **mesh = calloc(x * y, sizeof(struct component *));
	assert(mesh);

	struct component **pes = calloc(x * y, sizeof(struct component *));
	assert(pes);

	for (size_t i = 0; i < x; ++i)
	for (size_t j = 0; j < y; ++j) {
		struct component *node = create_mesh_node(i, j);
		clock_domain_add(clk, node);
		mesh[i * x + j] = node;

		if (i == 0 && j == 0)
			continue;

		if (i == 0 && j == 1)
			continue;

		struct component *imem = create_simple_mem(4096);
		init_simple_mem(imem, 0, _tmp_test_bin_len, _tmp_test_bin);

		uint64_t rcv = mesh_addr(i, j, 0);
		struct component *rv64 = create_simple_riscv64(rcv, 0, imem, node);
		simple_riscv64_set_reg(rv64, 10, i); /* a0 */
		simple_riscv64_set_reg(rv64, 11, j); /* a1 */

		clock_domain_add(clk, rv64);
		clock_domain_add(clk, imem);

		pes[i * x + j] = rv64;
	}

	struct component *uart = create_simple_uart();
	clock_domain_add(clk, uart);
	mesh_node_connect(mesh[0], NULL, mesh[x], mesh[1], NULL, uart);

	struct component *dmem = create_simple_mem(4096);
	clock_domain_add(clk, dmem);
	mesh_node_connect(mesh[1], NULL, mesh[x + 1], mesh[2], mesh[0], dmem);

	for (int i = 0; i < x; ++i)
	for (int j = 0; j < y; ++j) {
		if (i == 0 && j == 0)
			continue;

		if (i == 0 && j == 1)
			continue;

		struct component *node  = mesh[i * x + j];
		struct component *lower = pes[i * x + j];
		struct component *left  = get_mesh(mesh, i - 1, j    , x, y);
		struct component *right = get_mesh(mesh, i + 1, j    , x, y);
		struct component *up    = get_mesh(mesh, i    , j + 1, x, y);
		struct component *down  = get_mesh(mesh, i    , j - 1, x, y);
		mesh_node_connect(node, left, right, up, down, lower);
	}

	free(pes);
	free(mesh);
	return OK;
}

int main()
{
	struct clock_domain *clk = create_clock_domain(NS(1));

	stat r = build_mesh(clk, 16, 16);
	assert(r == OK);

	struct gran_root *root = create_root();
	root_add_clock(root, clk);

	r = root_run(root);
	assert(r == OK);

	destroy_root(root);
}
